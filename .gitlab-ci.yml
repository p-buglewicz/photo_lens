# GitLab CI/CD pipeline for LensAnalytics
# Runs tests, linting, and type checking

stages:
  - test
  - lint
  - quality

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"

cache:
  paths:
    - .cache/pip
    - .cache/uv
    - .venv

before_script:
  - apt-get update -qq && apt-get install -y -qq python3.12 python3.12-venv
  - pip install uv
  - uv sync --extra dev

test:unit:
  stage: test
  image: python:3.12-slim
  script:
    - echo "Running unit tests..."
    - uv run pytest -v --tb=short --cov=backend --cov-report=term --cov-report=html
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: htmlcov/index.html
    paths:
      - htmlcov/
    expire_in: 30 days
  allow_failure: false

test:health_endpoint:
  stage: test
  image: python:3.12-slim
  script:
    - echo "Running health endpoint tests..."
    - uv run pytest tests/test_health.py -v --tb=short
  allow_failure: false

lint:ruff:
  stage: lint
  image: python:3.12-slim
  script:
    - echo "Running ruff linter..."
    - uv run ruff check . --output-format=json > ruff-report.json || true
    - uv run ruff check .
  artifacts:
    when: always
    paths:
      - ruff-report.json
    expire_in: 30 days
  allow_failure: true

lint:black:
  stage: lint
  image: python:3.12-slim
  script:
    - echo "Checking code formatting with black..."
    - uv run black --check --diff .
  allow_failure: true

quality:typecheck:
  stage: quality
  image: python:3.12-slim
  script:
    - echo "Running mypy type checker..."
    - uv run mypy backend
  allow_failure: true
